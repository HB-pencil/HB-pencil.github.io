<!DOCTYPE html><html lang="zh-CN"><head><meta name="generator" content="Hexo 3.8.0"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>关于类加载机制的一些笔记 | Hopkin</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/normalize/8.0.1/normalize.min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//lib.baomitu.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//lib.baomitu.com/jquery/3.3.1/jquery.min.js"></script><link rel="icon" mask="" sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">关于类加载机制的一些笔记</h1><a id="logo" href="/.">Hopkin</a><p class="description">一个普通程序员的碎碎念 (。・∀・)ノ</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">关于类加载机制的一些笔记</h1><div class="post-meta">Nov 13, 2017<span> | </span><span class="category"><a href="/categories/计算机基础/">计算机基础</a><a href="/categories/计算机基础/计算机语言/">计算机语言</a></span></div><div class="post-content"><h2 id="类加载流程"><a href="#类加载流程" class="headerlink" title="类加载流程"></a>类加载流程</h2><p>基本过程：加载——验证——准备——解析——初始化——使用——卸载<br>加载：<br>1.获取定义这个类的二进制流，不一定从class文件获取，所以可以自定义类加载器。<br>2.将二进制流转为JVM方法区的数据结构，载入方法区<br>3.在方法区中生成Class对象，作为访问这个类信息的外部接口<br>验证：<br>1.文件格式验证，校验合法性，比如魔数值”cafebabe”<br>2.元数据验证，比如类和字段的合法性<br>3.字节码（指令）验证，即方法有没有恶意代码<br>准备：<br>static字段的0值初始化<br>解析（可能在加载后，初始化前或初始化后，取决于虚拟机）<br>将常量池的符号引用转为直接引用，即真正的名字，指向地址<br>初始化：<br>1.clinit()，static和static{}的赋值，init()，成员变量赋值，构造方法赋值<br>使用：<br>卸载：<br>1.反射对象不被引用<br>2.没有引用<br>3.类加载器已经卸载</p>
<p>被动引用不会出发类的初始化，类数组、访问父类static字段、访问其他类的static final 字段（本类在编译完成前就已经获取到常量的值，生成class文件后已和原来提供数据的类无关）</p>
<p>类加载器：双亲委派模型</p>
<h2 id="加载时初始化顺序"><a href="#加载时初始化顺序" class="headerlink" title="加载时初始化顺序"></a>加载时初始化顺序</h2><p>先加载父类static变量，再加载子类static变量，再初始化父类普通成员变量和构造方法，再初始化子类成员变量和构造方法。</p>
<h3 id="一个例子"><a href="#一个例子" class="headerlink" title="一个例子"></a>一个例子</h3><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title">SingleTon</span> &#123;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> SingleTon singleTon = <span class="keyword">new</span> SingleTon();</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> count1;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> count2 = <span class="number">0</span>;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="title">SingleTon</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">count1++;</span><br><span class="line">count2++;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> SingleTon <span class="title">getInstance</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line"><span class="keyword">return</span> singleTon;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Test</span> &#123;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span>(<span class="params">String[] args</span>)</span> &#123;</span><br><span class="line">SingleTon singleTon = SingleTon.getInstance();</span><br><span class="line">System.<span class="keyword">out</span>.println(<span class="string">"count1="</span> + singleTon.count1);</span><br><span class="line">System.<span class="keyword">out</span>.println(<span class="string">"count2="</span> + singleTon.count2)为</span><br><span class="line"> <span class="number">0</span></span><br><span class="line">  &#125; </span><br><span class="line"> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>输出结果为1和0    </p>
<p>###以下情况不会触发类的初始化</p>
<ul>
<li>调用父类静态变量</li>
<li>调用final常量</li>
<li>使用 A[] array = new A[10]</li>
</ul>
<p>##关于堆栈等变量的存储位置</p>
<p>###堆、方法区都是线程共享，栈、程序计数器线程独立</p>
<ul>
<li>常量池里面存储的是符号引用（首先要理解什么是符号引用，直接引用），以及final常量的字面值和字符串（字符串也是常量）</li>
<li>成员变量存在堆中（包括作为成员变量的对象的引用，很多人都说所有对象的引用都在栈中，好像不太对，因为栈是线程独立，对应的是各个方法），因为需要new出来才可以使用，依赖于对象实例</li>
<li>局部变量（包括作为形参及其传来的值）的基本数据类型存在栈中（包括变量名及其值）</li>
<li>局部变量的对象的引用存在栈中，实例存在堆中</li>
<li>static变量值存在方法区中，引用也在方法区</li>
<li>final存在常量池中，字符串也是，如果new String(“xxx”)，则在常量池也会存一份，堆中也会，引用指向所在堆</li>
<li>static final 值也是常量池中(如果是对象实例在堆，引用在方法区)，而常量池在堆中（jdk&lt;=7），所有new出来的都在堆</li>
<li>包装类计算时会自动拆包（装箱），byte，short，char计算后自动转int或更高。</li>
<li>Integer(100)实际上是Integer.valueOf(100),-128-127的会使用同一块地址，也就是引用相同。byte的范围刚好是-128-127，因为补码+0，-0对应都是00000000，也就是只有255个补码，规定10000000为-128补码，这就是为什么将byte转为十六进制需要 &amp;0xff</li>
</ul>
<p>###关于内存泄漏部分问题<br>非静态内部类实例隐式持有外部对象的引用，注意内存泄漏问题<br>方法内部类（匿名内部类）访问方法的变量必须为final，之所以为final是因为要保持方法原来变量内部类的值的一致性。<br>强引用<br>软引用（内存溢出前回收）<br>弱引用（GC时回收）<br>虚引用（回收时系统接到通知）</p>
<p>###关于Kotlin优雅使用internal<br>可以使用@JvmName(‘funcn  ame’)注解使用不规范方法名，java类将无法调用kotlin<br>可以直接粗暴使用</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fun <span class="string">'me  thod '</span>(a:Int,b:Int):Int = a + b</span><br></pre></td></tr></table></figure>
<p><a href="http://www.cnblogs.com/javaee6/p/3714716.html" target="_blank" rel="noopener">参考文章1</a><br><a href="https://www.cnblogs.com/Eason-S/p/5658230.html" target="_blank" rel="noopener">参考文章2</a></p>
</div><div><ul class="post-copyright"><li class="post-copyright-author"><strong>本文作者：</strong>hopkin</li><li class="post-copyright-link"><strong>本文链接：</strong><a href="/2017/11/13/关于类加载机制的一些笔记/">https://hb-pencil.github.io/2017/11/13/关于类加载机制的一些笔记/</a></li><li class="post-copyright-license"><strong>版权声明：</strong>Copyright © 2019 Hopkin</li></ul></div><br><script type="text/javascript" src="/js/share.js?v=0.0.0" async></script><a class="article-share-link" data-url="https://hb-pencil.github.io/2017/11/13/关于类加载机制的一些笔记/" data-id="cjz6sxclc001sqgibvh66rjii" data-qrcode="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAN4AAADeCAAAAAB3DOFrAAACt0lEQVR42u3awW7CMBAEUP7/p1upp0o06czaBg4vJwTByfPBuxr78Yivr5/r9+ff3zx///zr1ZjP91/9NxlzeOHh4eGNXv3quhr6/p576uxF78e/nFY8PDy8Y7xkuPxh9y9xv3onvxbFAw8PD++tvLZp3tWgJ9ONh4eH95m8PFBIFv38v3h4eHifyUvCiHzQPJhYyV03Zy14eHh4MW/WBL/38/H9PTw8PLzREtxeuwLZpPmO3gcPDw/vAC95oaRUzF6lDXbbzTA8PDy807w2CEgW8eTxeTOdv8kfhQEPDw9vE689VpU/LC8n7VGtIlDGw8PDO8ZrG9xZMWjb66Sc/DO5eHh4eAd4Sbgwa2pnsUK7AZYXDDw8PLxX8vZuhuWYfIrx8PDw3sVrqcningcH+f2zYoOHh4e3i7e+uOebZ20o3DbfeHh4eK/hJbeutLOzgtGWnOS5eHh4eLt4SRDQbuG3hWF2yKBoqfHw8PAO8GYPXg8a2u/ziHl6vgAPDw+v47UFYNcWWvLfPETGw8PDO81rh05ii9mYbWRclwc8PDy8Tbw8XGiX6dkUzKLbIsbFw8PDW+a1i/LK8YJk46rFFyUEDw8PbytvthDPikQbHOfTsbSThoeHh7cAmx2BmkUJeVicRxhRyoKHh4e3wGsT3/Xt/zbw3dys4+Hh4W3l7Tp61U5HHhznIzza2oKHh4dX8mbbS+0r5tTNgQUeHh7eYd5sCyppi9v4oA1KLp+Ih4eHt5X3VV5t851v868HH5dnyvDw8PC28ma78LMYoj24sDJBeHh4eKd5szhgvbFu574tIXh4eHinebOGeHb/7JulGBcPDw/vrbzZptTpI1l4eHh4n8nLt7LWW+TZ4QY8PDy8V/LypXy2/d8y2gJwWajw8PDwDvA2nNtaWOjziV6JkvHw8PA28b4BlYtBBe/gTeoAAAAASUVORK5CYII=">分享</a><div class="tags"></div><div class="post-nav"><a class="pre" href="/2018/01/01/十二月份复习部分重要知识点总结/">十二月份复习部分重要知识点总结</a><a class="next" href="/2017/10/11/关于方法内部的类使用final/">关于方法内部的类使用final</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/计算机基础/">计算机基础</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/计算机基础/Android知识/">Android知识</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/计算机基础/数据结构与算法/">数据结构与算法</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/计算机基础/计算机网络/">计算机网络</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/计算机基础/计算机语言/">计算机语言</a></li></ul></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/计算机知识/" style="font-size: 15px;">计算机知识</a> <a href="/tags/经验记录/" style="font-size: 15px;">经验记录</a> <a href="/tags/随笔杂文/" style="font-size: 15px;">随笔杂文</a> <a href="/tags/小技巧/" style="font-size: 15px;">小技巧</a> <a href="/tags/他山之石/" style="font-size: 15px;">他山之石</a> <a href="/tags/新技术/" style="font-size: 15px;">新技术</a> <a href="/tags/胡思乱想/" style="font-size: 15px;">胡思乱想</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2019/08/11/811工作记录/">工作记录小知识1</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/06/12/工作业余计划/">工作业余计划</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/03/08/Android自定义FlowLayout/">Android自定义FlowLayout</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/01/22/打家劫舍123/">打家劫舍123</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/01/16/N数之和/">N数之和</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/01/10/一些思考和总结/">一些思考和总结</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/01/10/2018年终总结/">2018年终总结</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/12/28/部分高质量文章收藏/">部分高质量文章收藏</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/12/26/Flutter相关文章收藏/">Flutter相关文章收藏</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/10/10/背包问题之回溯和动态规划/">背包问题之回溯和动态规划</a></li></ul></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2019 <a href="/." rel="nofollow">Hopkin.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//lib.baomitu.com/fancybox/3.5.2/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/fancybox/3.5.2/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>